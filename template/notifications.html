{% load static %}
<li class="dropdown" id="notifications_system">
    <a class="dropdown-toggle waves-effect waves-light" data-toggle="dropdown" id="btn_notifications" href="#"><i class="icon-envelope"></i>
        <!-- <div class="notify"><span class="heartbit"></span><span class="point"></span></div> -->
    </a>
    <ul class="dropdown-menu mailbox animated bounceInDown">
        <li>
            <div class="drop-title">No tiene Mensajes nuevos</div>
        </li>
        {% for i in noty %}
        <li>
            <div class="message-center">
                <a href="#">
                    <div class="mail-contnet">
                        <h5>Pavan kumar</h5> 
                        <span class="mail-desc">Just see the my admin!</span> 
                        <span class="time">9:30 AM</span> 
                    </div>
                </a>
            </div>
        </li>
        {% endfor %}
        <li>
            <a class="text-center" href="javascript:void(0);"> <strong>Ver Todas las notificiaciones</strong> <i class="fa fa-angle-right"></i> </a>
        </li>
    </ul>
</li>

<audio hidden class="audio" id="audio" controls>
    <source src="{% static 'tienes_un_mensaje.mp3' %}" type="audio/mp3">
</audio>
<!-- <script src="{% static 'plugins/bower_components/jquery/dist/jquery.min.js' %}"></script>

<script type="text/javascript">
    let last = 0;
    $(document).ready(function(){
        function sound() {
            let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let xhr = new XMLHttpRequest();
            xhr.open('GET', "{% static 'tienes_un_mensaje.mp3' %}");
            xhr.responseType = 'arraybuffer';
            xhr.addEventListener('load', () => {
                let playsound = (audioBuffer) => {
                    let source = audioCtx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioCtx.destination);
                    source.loop = false;
                    source.start();

                    setTimeout(function () {
                        let t = document.createElement('p');
                        t.appendChild(document.createTextNode((new Date()).toLocaleString() + ': Sound played'));
                        document.querySelector('.output').appendChild(t);
                        playsound(audioBuffer);
                    }, 100000000000000000);
                };

                audioCtx.decodeAudioData(xhr.response).then(playsound);
            });
            xhr.send();
        }

        var stop = 1000
        let exist = false
        
        setInterval(function(){

            $(".notification_invoice_").empty()
            $.ajax({
                url:"{% url 'notofitications' %}",
                success:function(data){
                    let _data = JSON.parse(data)
                    if(_data.length){
                        $(".notify").css('display','block')
                        let n = _data.length
                        if(parseFloat(last) < parseFloat(_data[n - 1]['pk'])){
                            sound()
                            last = _data[n - 1]['pk']
                        }

                        console.log(last)
                        console.log(_data[n -1]['pk'])

                        let i = 0
                        for(i; i < 5; i++){
                            var message;
                            if(_data[i]['acceptance']){
                                message = "La factura "+_data[i]['number']+' fue aceptada'
                            }
                            else{
                                message = "La factura "+_data[i]['number']+' fue rechazada'
                            }

                            $(".notification_invoice_").append(`
                                <li>
                                    <div class="message-center">
                                        <a href="{% url 'List_Notifications' %}">
                                            <div class="mail-contnet">
                                                <h5></h5> 
                                                <span class="mail-desc">${message}</span> 
                                                <span class="time">${_data[i]['time']}</span> 
                                            </div>
                                        </a>
                                    </div>
                                </li>
                            `)
                        }
                        $(".notification_invoice_").append(`
                            <li>
                                <a class="text-center" href="{% url 'List_Notifications' %}"> <strong>Ver Todas las notificiaciones</strong> <i class="fa fa-angle-right"></i> </a>
                            </li>
                        `)
                        
                        
                       
                    }else{
                        $(".notification_invoice_").append(`
                                <li>
                                    <div class="drop-title">No tiene Mensajes nuevos</div>
                                </li>
                            `)
                    }
                    
                }
            })
        },stop)
    })
</script> -->